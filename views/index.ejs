<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/logo.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Sawaal
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
    name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css"
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="./assets/css/material-dashboard.css?v=2.1.0" rel="stylesheet" />
</head>

<body class="">
  <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
    <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="navbar-toggler-icon icon-bar"></span>
        <span class="navbar-toggler-icon icon-bar"></span>
        <span class="navbar-toggler-icon icon-bar"></span>
    </button>
  </nav>
  <div class="wrapper ">
      <div class="sidebar" data-color="purple" data-background-color="white" data-image="./assets/img/sidebar-1.jpg">
        <div class="logo">
          <a href="/" class="simple-text logo-normal">
            <img style="-webkit-filter: drop-shadow(1px 1px 1px black) drop-shadow(1px -1px 1px black); filter: drop-shadow(1px 1px 1px black) drop-shadow(-1px -1px 1px black);" src="assets/img/logo.png" width="100" height="100"/>
          </a>
        </div>
        <div class="sidebar-wrapper">
          <ul class="nav">
            <li class="nav-item active">
              <a class="nav-link" href="/">
                <i class="material-icons">search</i>
                <p>Find Paper</p>
              </a>
            </li>
            <li class="nav-item ">
              <a class="nav-link" href="leaderboard">
                <i class="material-icons">star</i>
                <p>Leaderboard</p>
              </a>
            </li>
            <li class="nav-item ">
              <a class="nav-link" href="about">
                <i class="material-icons">info_outline</i>
                <p>About</p>
              </a>
            </li>
          </ul>
        </div>
      </div>
    <div class="main-panel">
      <div class="content">
        <div class="container-fluid">
          <%- include('loading') %>
          <div class="row maincontent" hidden>
            <div class="col-md-9" style="margin: 0 auto">

              <% for (var i = 0; i < papers.length; i++) { %>

                <%if ( "isYear" in papers[i]) { %>
              <div class="card">
                  <div class="card-body">
                    <div class="row" style="margin-left: 60px">
                        <div class="col-md-12" style="text-align: center">
                            <h3><%- papers[i].year %></h3> 
                        </div>
                    </div>
                  </div>
                </div>
                

                  <% } else { %>

              <div class="card">
                <div class="card-body">
                  <div style="width:41px; position: absolute; top: 50%; -moz-transform: translateY(-50%); -webkit-transform: translateY(-50%); transform: translateY(-50%);">
                    
                      <button class="btn btn-round btn-just-icon btn-primary upvote voters" id="u<%- i %>" style="font-size: 29;"
                          onclick="clicked(true,'u<%- i %>','d<%- i %>','t<%- i %>','<%- i %>')">
                      <i class="material-icons" style="font-size: 1.2em; text-align: center" >keyboard_arrow_up</i>
                      </button> 


                    <h4 style="text-align: center; margin-bottom: 0" id="t<%- i %>"><%- papers[i].totalVotes %></h4>

                      <button class="btn btn-round btn-just-icon btn-primary downvote voters" id="d<%- i %>"  style="font-size: 29;"
                          onclick="clicked(false,'d<%- i %>','u<%- i %>','t<%- i %>','<%- i %>')">
                          <i class="material-icons" style="font-size: 1.2em; text-align: center" >keyboard_arrow_down</i>
                        </button> 

                  </div>
                  <div class="row" style="margin-left: 60px">
                    <h3 class="col-md-4 card-title" style="text-align: center"><%- papers[i].CourseCode %></h4>
                    <h3 class="col-md-4 card-title" style="text-align: center"><%- papers[i].Type %></h4>
                    <h3 class="col-md-4 card-title" style="text-align: center"><%- papers[i].Year %></h4>
                  </div>
                  <div class="row" style="margin-left: 60px">
                      <div class="col-md-12" style="text-align: center">
                          <h5>Prof: <%- papers[i].Prof %></h5> 
                      </div>
                  </div>
                  <div class="row" style="margin-left: 60px">
                      <div class="col-md-12" style="text-align: center">
                          <a href="<%- papers[i].FileUrl %>" target="_blank" class="btn btn-primary btn-round">Download</a>
                      </div>
                  </div>
                </div>
              </div>

              <% } %>
              <% }; %>
            </div>
          </div>
        </div>
      </div>
      <%- include('footer') %>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script src="./assets/js/core/jquery.min.js" type="text/javascript"></script>
  <script src="./assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="./assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
  <script src="./assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!--  Google Maps Plugin    -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>
  <!-- Chartist JS -->
  <script src="./assets/js/plugins/chartist.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="./assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="./assets/js/material-dashboard.min.js?v=2.1.0" type="text/javascript"></script>
  <!-- Material Dashboard DEMO methods, don't include it in your project! -->
  <script src="./assets/demo/demo.js"></script>
    <%- include('auth') %>
    <script>
    var db = firebaseApp.database();

      var userMail = "";
      auth.onAuthStateChanged(function(user) {
      if (user) {
        userMail = auth.currentUser.email;
        highlight(userMail);
      } else {
        // No user is signed in.
      }
      });

      function inArray(needle, haystack){
        var found = 0;
        for (var i=0, len=haystack.length;i<len;i++) {
            if (haystack[i] == needle) return i;
                found++;
        }
        return -1;
      }

    function highlight(userMail){ 

      var papers = '<%- JSON.stringify(papers) %>';
      var papersObj = JSON.parse(papers);

      $('.voters').each(function(i, obj) {
          var id = obj["id"];
          var idSel = '#'+id;
          var ind = Number(id[1]);
          
          if(id[0] == 'u'){
            var upvoters = papersObj[ind].upvoters;

            if(inArray(userMail,upvoters) != -1){
              $(idSel).addClass("active");
            }
          }
          else{
            var downvoters = papersObj[ind].downvoters;

            if(inArray(userMail,downvoters) != -1){
              $(idSel).addClass("active");
            }
          }
      });
    }

 

    function clicked(isUpvote,myId,otherId,textId,index){

      var mainSelector = '#'+myId;
      var otherSelector = '#'+otherId;
      var textSelector = '#'+textId;

      index = Number(index);

      var paperString = '<%- JSON.stringify(papers) %>';
      var papers = JSON.parse(paperString);
      
      if(isUpvote){
        if($(mainSelector).hasClass("active")){
          $(mainSelector).removeClass("active");
          $(mainSelector).blur();

          var votes = Number($(textSelector).text());
          $(textSelector).text(votes-1);

          performTransactions(-1,0,0,1,0,0,papers[index]);
        }
        else{
          $(mainSelector).addClass("active");
          $(mainSelector).blur();
          var votes = Number($(textSelector).text());

          if($(otherSelector).hasClass("active")){
              $(otherSelector).removeClass("active");
              $(textSelector).text(votes+2);

              performTransactions(1,-1,1,0,0,1,papers[index]);

          }
          else{
              $(textSelector).text(votes+1);

              performTransactions(1,0,1,0,0,0,papers[index]);

          }

        }
      }
      else{
        if($(mainSelector).hasClass("active")){
          $(mainSelector).removeClass("active");
          $(mainSelector).blur();

          var votes = Number($(textSelector).text());
          $(textSelector).text(votes+1);

          performTransactions(0,-1,0,0,0,1,papers[index]);
        }
        else{
          $(mainSelector).addClass("active");
          $(mainSelector).blur();
          var votes = Number($(textSelector).text());

          if($(otherSelector).hasClass("active")){
              $(otherSelector).removeClass("active");
              $(textSelector).text(votes-2);

              performTransactions(-1,1,0,1,1,0,papers[index]);

          }
          else{
              $(textSelector).text(votes-1);
              performTransactions(0,1,0,0,1,0,papers[index]);

          }

        }
      }

    }

    function performTransactions(upChange,downChange,addup,delup,addown,deldown,paper){
    
      var referString = "Uploads/" + paper.CourseCode + "_" + paper.Type + "/" + paper.Year + "/" + paper.key;
      var paperRef = db.ref(referString);

      var uploaderRefString = "Users/" + paper.uploaderID;
      var uploaderRef = db.ref(uploaderRefString);

      // Change number of upvotes.
      paperRef.child("upvoteCount").transaction( (value) => {
        if(value != null){
          value += upChange;
        }
        return value;
      });

      // Change number of downvotes.
      paperRef.child("downvoteCount").transaction( (value) => {
        if(value != null){
          value += downChange;
        }
        return value;
      });

      // Update upvoters list.
      paperRef.child("upvoters").transaction( (value) => {
        if(value != null){
          if(addup==1){
            value.push(userMail);
          }
          else if(delup==1){
            value.splice(value.indexOf(userMail),1);
          }
        }
        return value;
      });

      // Update downvoters list.
      paperRef.child("downvoters").transaction( (value) => {
        if(value != null){
          if(addown==1){
            value.push(userMail);
          }
          else if(deldown==1){
            value.splice(value.indexOf(userMail),1);
          }
        }
        return value;
      });

      // Change total votes.
      paperRef.child("totalVotes").transaction( (value) => {
        if(value != null){
          value = value + upChange - downChange;
        }
        return value;
      });

      // Update uploader score.
      uploaderRef.child("Score").transaction( (value) => {
        if(value != null){
          value = value + 5*(upChange - downChange);
        }
        return value;
      });


    }

  </script>
</body>

</html>